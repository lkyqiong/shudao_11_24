# 退出登录功能说明

## 一、功能概述

在个人中心页面（Profile.vue）的用户名右侧添加了设置按钮，点击后可以弹出菜单选择"退出登录"，实现用户登出功能。

## 二、功能位置

**文件路径：** `src/views/user/Profile.vue`

**页面位置：** 个人中心页面的用户信息区域，用户名"lky"的右侧

## 三、实现的功能

### 3.1 UI交互
1. **设置按钮**
   - 图标：使用 `src/assets/images/set_up.png`
   - 位置：用户名右侧
   - 交互：鼠标悬停时旋转30度

2. **下拉菜单**
   - 点击设置按钮，显示/隐藏菜单
   - 菜单包含"退出登录"选项
   - 带有滑入动画效果
   - 悬停时背景变色

3. **退出登录**
   - 点击"退出登录"选项
   - 清除 localStorage 中的登录状态
   - 自动跳转到登录页

### 3.2 代码实现

#### HTML 结构（第 36-48 行）
```vue
<div class="user-info">
  <div class="user-avatar"></div>
  <div class="username">{{ username }}</div>

  <!-- 设置按钮 -->
  <div class="settings-container">
    <img
      src="@/assets/images/set_up.png"
      alt="设置"
      class="settings-btn"
      @click="toggleSettings"
    />
    <!-- 下拉菜单 -->
    <div v-if="showSettings" class="settings-menu">
      <div class="menu-item" @click="handleLogout">退出登录</div>
    </div>
  </div>
</div>
```

#### JavaScript 逻辑

**1. 状态变量（第 84 行）**
```typescript
// 控制设置菜单的显示
const showSettings = ref(false);
```

**2. 切换菜单显示（第 96-101 行）**
```typescript
const toggleSettings = () => {
  showSettings.value = !showSettings.value;
};
```

**3. 退出登录函数（第 103-113 行）**
```typescript
const handleLogout = () => {
  // 清除登录状态
  localStorage.removeItem('isLoggedIn');
  localStorage.removeItem('username');

  // 跳转到登录页
  router.push('/login');
};
```

#### CSS 样式（第 310-363 行）

**设置按钮容器**
```css
.settings-container {
  position: relative;
  margin-left: 1vw;
}
```

**设置按钮**
```css
.settings-btn {
  width: 2.5vw;
  height: 2.5vw;
  cursor: pointer;
  transition: transform 0.3s;
}

.settings-btn:hover {
  transform: rotate(30deg);  /* 悬停旋转效果 */
}
```

**下拉菜单**
```css
.settings-menu {
  position: absolute;
  top: 3.5vw;
  left: 0;
  background: white;
  border-radius: 8px;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
  overflow: hidden;
  z-index: 100;
  min-width: 120px;
  animation: slideDown 0.2s ease-out;  /* 滑入动画 */
}
```

**菜单项**
```css
.menu-item {
  padding: 1.2vh 1.5vw;
  color: #333;
  font-size: 1vw;
  cursor: pointer;
  transition: background 0.2s;
  white-space: nowrap;
}

.menu-item:hover {
  background: #f5f5f5;
  color: #5a9090;  /* 悬停时变色 */
}
```

## 四、使用流程

```
1. 用户登录成功 → 访问个人中心页面
   ↓
2. 点击用户名右侧的设置按钮（齿轮图标）
   ↓
3. 弹出下拉菜单，显示"退出登录"选项
   ↓
4. 点击"退出登录"
   ↓
5. localStorage 被清除：
   - isLoggedIn: 删除
   - username: 删除
   ↓
6. 自动跳转到登录页 (/login)
   ↓
7. 由于登录状态已清除，无法再访问受保护的页面
```

## 五、退出登录的完整机制

### 5.1 清除的数据
执行 `handleLogout()` 时，会清除以下 localStorage 数据：

| 键名 | 作用 | 清除方式 |
|------|------|----------|
| `isLoggedIn` | 登录状态标识 | `localStorage.removeItem('isLoggedIn')` |
| `username` | 用户名 | `localStorage.removeItem('username')` |

### 5.2 路由守卫的响应
当 localStorage 被清除后，路由守卫会自动生效：

**router/index.ts 第 64-79 行的守卫逻辑：**
```typescript
router.beforeEach((to, from, next) => {
  const isLoggedIn = localStorage.getItem('isLoggedIn') === 'true';

  // 需要登录的页面
  const requiresAuth = !['Login', 'Register'].includes(to.name as string);

  if (requiresAuth && !isLoggedIn) {
    // 未登录，跳转到登录页
    next('/login');
  } else {
    next();
  }
});
```

退出登录后，`isLoggedIn` 为 `null`（不等于 `'true'`），所以：
- 访问任何受保护页面都会被重定向到 `/login`
- 需要重新登录才能访问首页、个人中心等页面

## 六、视觉效果

### 6.1 设置按钮
- **正常状态**：齿轮图标，大小 2.5vw × 2.5vw
- **悬停状态**：图标旋转30度，提示可点击

### 6.2 下拉菜单
- **显示方式**：点击设置按钮后显示
- **位置**：设置按钮正下方
- **动画**：从上往下滑入（0.2秒）
- **样式**：白色背景，圆角，阴影

### 6.3 退出登录选项
- **正常状态**：黑色文字
- **悬停状态**：背景变浅灰色，文字变青色（#5a9090）

## 七、与其他页面的对比

### 7.1 其他Layout页面没有退出功能
以下页面只有"首页"按钮，没有退出登录：
- HeritageLayout.vue（古迹篇）
- SceneryLayout.vue（新景篇）
- NetworkLayout.vue（脉络篇）
- RouteLayout.vue（行迹篇）

### 7.2 建议扩展
可以考虑在所有 Layout 页面的导航栏添加退出登录功能，方便用户在任何页面都能退出。实现方式：
1. 创建一个公共的 Header 组件
2. 在 Header 中包含退出登录功能
3. 各个 Layout 页面引用这个 Header 组件

## 八、测试步骤

### 测试1：正常退出登录
```
1. 登录系统（lky / 123456）
2. 进入个人中心页面
3. 点击设置按钮 → 确认菜单弹出
4. 点击"退出登录" → 确认跳转到登录页
5. 尝试访问 /home → 确认被重定向到 /login
6. 打开浏览器开发者工具 → Application → Local Storage
   → 确认 isLoggedIn 和 username 已被删除
```

### 测试2：菜单显示/隐藏
```
1. 进入个人中心页面
2. 点击设置按钮 → 菜单显示
3. 再次点击设置按钮 → 菜单隐藏
4. 点击设置按钮 → 菜单显示
5. 悬停在"退出登录"上 → 确认背景和文字颜色变化
```

### 测试3：退出后无法访问受保护页面
```
1. 退出登录后
2. 手动在地址栏输入：
   - http://localhost:5173/home
   - http://localhost:5173/profile
   - http://localhost:5173/heritage
3. 确认所有页面都自动跳转到 /login
```

## 九、技术要点

### 9.1 使用的 Vue 3 特性
- **ref**：响应式状态管理（showSettings）
- **v-if**：条件渲染菜单
- **@click**：事件绑定
- **Composition API**：script setup 语法

### 9.2 LocalStorage 操作
- **removeItem()**：删除指定键的数据
- **getItem()**：路由守卫中读取登录状态

### 9.3 路由操作
- **router.push()**：编程式导航到登录页
- **路由守卫**：自动拦截未登录用户访问

### 9.4 CSS 技巧
- **定位**：relative + absolute 实现下拉菜单定位
- **动画**：@keyframes 实现滑入效果
- **过渡**：transition 实现平滑的悬停效果
- **z-index**：确保菜单显示在其他内容上方

## 十、代码改动摘要

**文件：** `src/views/user/Profile.vue`

**改动内容：**
1. ✅ HTML：添加设置按钮和下拉菜单（第 36-48 行）
2. ✅ JavaScript：添加 showSettings 状态变量（第 84 行）
3. ✅ JavaScript：添加 toggleSettings 函数（第 96-101 行）
4. ✅ JavaScript：添加 handleLogout 函数（第 103-113 行）
5. ✅ CSS：添加设置按钮和菜单样式（第 310-363 行）

**未改动的文件：**
- router/index.ts（路由守卫已存在，无需修改）
- Login.vue（登录逻辑无需改动）

## 十一、常见问题

### Q1: 点击设置按钮没有反应？
**A:** 检查以下几点：
1. 确认 `src/assets/images/set_up.png` 图片存在
2. 检查浏览器控制台是否有错误
3. 确认 `@click="toggleSettings"` 绑定正确

### Q2: 退出登录后为什么还能看到首页？
**A:** 可能的原因：
1. localStorage 没有被正确清除（检查开发者工具）
2. 路由守卫没有生效（检查 router/index.ts）
3. 浏览器缓存问题（尝试硬刷新 Ctrl+Shift+R）

### Q3: 如何添加更多菜单项？
**A:** 在 `settings-menu` 中添加更多 `menu-item`：
```vue
<div v-if="showSettings" class="settings-menu">
  <div class="menu-item" @click="handleEditProfile">编辑资料</div>
  <div class="menu-item" @click="handleSettings">账号设置</div>
  <div class="menu-item" @click="handleLogout">退出登录</div>
</div>
```

### Q4: 如何在点击页面其他地方时关闭菜单？
**A:** 可以添加全局点击监听：
```typescript
const handleClickOutside = (event: MouseEvent) => {
  const target = event.target as HTMLElement;
  if (!target.closest('.settings-container')) {
    showSettings.value = false;
  }
};

onMounted(() => {
  document.addEventListener('click', handleClickOutside);
});

onUnmounted(() => {
  document.removeEventListener('click', handleClickOutside);
});
```

## 十二、总结

退出登录功能已成功实现，主要特点：
- ✅ UI 美观，交互流畅
- ✅ 功能完整，清除登录状态
- ✅ 自动跳转，用户体验好
- ✅ 路由守卫配合，安全可靠

用户现在可以方便地在个人中心页面退出登录，系统会自动清除登录状态并跳转到登录页，确保账户安全。
