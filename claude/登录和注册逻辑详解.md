# 登录和注册逻辑详解

## 一、登录状态判断机制

### 1.1 状态存储位置
系统使用浏览器的 `localStorage` 来存储登录状态：
```javascript
// 登录成功时设置
localStorage.setItem('isLoggedIn', 'true');
localStorage.setItem('username', username.value);

// 检查登录状态
const isLoggedIn = localStorage.getItem('isLoggedIn') === 'true';
```

### 1.2 路由守卫判断（核心机制）
在 `src/router/index.ts` 的第 63-79 行实现了路由守卫：

```typescript
router.beforeEach((to, from, next) => {
  const isLoggedIn = localStorage.getItem('isLoggedIn') === 'true';

  // 需要登录的页面
  const requiresAuth = !['Login', 'Register'].includes(to.name as string);

  if (requiresAuth && !isLoggedIn) {
    // 未登录，跳转到登录页
    next('/login');
  } else if ((to.name === 'Login' || to.name === 'Register') && isLoggedIn) {
    // 已登录，访问登录/注册页时跳转到首页
    next('/home');
  } else {
    next();
  }
});
```

**判断逻辑：**
1. **未登录 + 访问受保护页面** → 强制跳转到 `/login`
2. **已登录 + 访问登录/注册页** → 强制跳转到 `/home`
3. **其他情况** → 正常放行

### 1.3 应用启动时的页面判断
在 `src/router/index.ts` 第 6-8 行：
```typescript
{
  path: '/',
  redirect: '/login',
}
```
- 访问根路径 `/` 时会重定向到 `/login`
- 但由于路由守卫的存在，如果 localStorage 中存在登录状态，会再次被重定向到 `/home`

**流程图：**
```
用户访问 /
  ↓
重定向到 /login
  ↓
路由守卫检查 localStorage.isLoggedIn
  ↓
├─ 'true' → 重定向到 /home（已登录状态）
└─ null/false → 停留在 /login（未登录状态）
```

---

## 二、注册新用户的问题

### 2.1 当前系统的认证缺陷

**问题核心：登录验证是硬编码的**

在 `src/views/auth/Login.vue` 第 68-86 行：
```typescript
const handleLogin = () => {
  // 验证用户名和密码（硬编码）
  if (username.value === 'lky' && password.value === '123456') {
    // 登录成功
    localStorage.setItem('isLoggedIn', 'true');
    localStorage.setItem('username', username.value);
    router.push('/home');
  } else {
    // 登录失败
    showError.value = true;
    setTimeout(() => {
      showError.value = false;
    }, 3000);
  }
};
```

**硬编码意味着：**
- 只有用户名 `lky` 和密码 `123456` 这个组合能通过验证
- 其他任何组合（包括 lky/1234）都会登录失败

### 2.2 注册功能的实际行为

在 `src/views/auth/Register.vue` 第 69-82 行：
```typescript
const handleRegister = () => {
  if (!username.value || !password.value) {
    alert('请填写完整信息');
    return;
  }

  // 模拟注册成功
  showSuccess.value = true;

  // 2秒后跳转到登录页
  setTimeout(() => {
    router.push('/login');
  }, 2000);
};
```

**问题：**
1. 注册时填写的用户名和密码**没有被保存到任何地方**
2. 只是显示"注册成功"的提示，然后跳转到登录页
3. **注册的数据完全没有被存储**（既没有后端API，也没有存到 localStorage）

### 2.3 场景分析

**场景：注册 lky/1234**
```
1. 用户在注册页输入：
   用户名: lky
   密码: 1234

2. 点击"注册"按钮
   ↓
   显示"注册成功！即将跳转到登录页..."
   ↓
   2秒后跳转到登录页
   ↓
   输入 lky/1234 尝试登录
   ↓
   ❌ 登录失败（因为硬编码只认 lky/123456）
   ↓
   显示"用户名或密码错误"
```

**只有以下情况能成功登录：**
- 用户名: `lky`（严格相等）
- 密码: `123456`（严格相等）

---

## 三、登录和注册代码逻辑梳理

### 3.1 应用启动流程

```
应用启动 (main.ts)
  ↓
创建 Vue 应用
  ↓
挂载 Router
  ↓
渲染 App.vue
  ↓
<router-view /> 根据路由显示组件
  ↓
访问 / → 重定向到 /login
  ↓
路由守卫检查 localStorage.isLoggedIn
  ↓
├─ 已登录 → 跳转到 /home
└─ 未登录 → 停留在 /login
```

### 3.2 登录流程详解

**文件：`src/views/auth/Login.vue`**

#### 流程图
```
用户打开登录页
  ↓
输入用户名和密码
  ↓
点击"登录"按钮 / 按下回车键
  ↓
触发 handleLogin() 函数
  ↓
检查：username === 'lky' && password === '123456'
  ↓
├─ 是 → ① 设置 localStorage.isLoggedIn = 'true'
│       ② 设置 localStorage.username = 'lky'
│       ③ 跳转到 /home
│
└─ 否 → ① 显示错误提示："用户名或密码错误"
        ② 3秒后自动隐藏错误提示
        ③ 停留在登录页
```

#### 关键代码位置
| 行号 | 功能 | 代码 |
|------|------|------|
| 15-20 | 用户名输入 | `v-model="username"` + 回车监听 |
| 24-30 | 密码输入 | `v-model="password"` + 回车监听 |
| 32 | 登录按钮 | `@click="handleLogin"` |
| 68-86 | 登录逻辑 | 硬编码验证 + localStorage 存储 |
| 10 | 错误提示 | `v-if="showError"` 控制显示 |

### 3.3 注册流程详解

**文件：`src/views/auth/Register.vue`**

#### 流程图
```
用户打开注册页
  ↓
输入用户名和密码
  ↓
点击"注册"按钮 / 按下回车键
  ↓
触发 handleRegister() 函数
  ↓
检查：用户名和密码是否都已填写
  ↓
├─ 否 → 弹出 alert："请填写完整信息"
│
└─ 是 → ① 显示成功提示："注册成功！即将跳转到登录页..."
        ② 2秒后跳转到 /login
        ③ ⚠️ 注意：输入的数据没有被保存！
```

#### 关键代码位置
| 行号 | 功能 | 代码 |
|------|------|------|
| 30-36 | 用户名输入 | `v-model="username"` + 回车监听 |
| 39-46 | 密码输入 | `v-model="password"` + 回车监听 |
| 48 | 注册按钮 | `@click="handleRegister"` |
| 69-82 | 注册逻辑 | 仅显示成功提示，无实际存储 |
| 24-26 | 成功提示 | `v-if="showSuccess"` 控制显示 |

### 3.4 路由守卫流程

**文件：`src/router/index.ts`**

#### 执行时机
- **每次路由跳转之前**都会执行
- 包括：手动跳转、浏览器前进/后退、直接输入URL

#### 详细逻辑
```
路由即将跳转（从 from → to）
  ↓
执行 beforeEach 钩子
  ↓
读取 localStorage.isLoggedIn
  ↓
判断目标路由是否需要认证
requiresAuth = !['Login', 'Register'].includes(to.name)
  ↓
情况1：需要认证 && 未登录
  → next('/login') 强制跳转到登录页

情况2：访问登录/注册页 && 已登录
  → next('/home') 强制跳转到首页

情况3：其他情况
  → next() 正常放行
```

#### 受保护的路由
以下路由需要登录才能访问：
- `/home` - 首页
- `/heritage` - 古迹篇
- `/scenery` - 新景篇
- `/network` - 脉络篇
- `/route` - 行迹篇
- `/profile` - 个人中心

#### 公开路由
以下路由无需登录：
- `/login` - 登录页
- `/register` - 注册页

---

## 四、数据流向图

### 4.1 登录数据流
```
Login.vue (用户输入)
  ↓
username.value = "lky"
password.value = "123456"
  ↓
点击登录
  ↓
handleLogin() 函数
  ↓
硬编码验证通过
  ↓
localStorage.setItem('isLoggedIn', 'true')
localStorage.setItem('username', 'lky')
  ↓
router.push('/home')
  ↓
路由守卫检查通过
  ↓
显示 HomeLayout.vue
  ↓
Profile.vue 从 localStorage.getItem('username') 读取用户名
```

### 4.2 注册数据流（存在问题）
```
Register.vue (用户输入)
  ↓
username.value = "任意用户名"
password.value = "任意密码"
  ↓
点击注册
  ↓
handleRegister() 函数
  ↓
显示"注册成功"
  ↓
❌ 数据没有被保存到任何地方！
  ↓
2秒后跳转到 /login
  ↓
无法使用刚才注册的账号登录
（因为 Login.vue 只认硬编码的 lky/123456）
```

---

## 五、当前系统的局限性

### 5.1 主要问题

1. **硬编码认证**
   - 只能使用 `lky/123456` 登录
   - 无法添加新用户
   - 密码明文写在代码中（不安全）

2. **注册功能无效**
   - 注册的数据不会被保存
   - 注册后无法使用新账号登录
   - 只是一个UI演示

3. **无后端支持**
   - 没有数据库存储用户信息
   - 没有API接口
   - 依赖 localStorage（刷新浏览器数据会丢失）

4. **安全性问题**
   - 没有密码加密
   - 没有token验证
   - 登录状态可以被手动修改（F12控制台执行 `localStorage.setItem('isLoggedIn', 'true')`）

### 5.2 如何改进（建议）

#### 方案1：使用 localStorage 存储用户数据（简单）
```typescript
// 注册时
const users = JSON.parse(localStorage.getItem('users') || '[]');
users.push({ username: username.value, password: password.value });
localStorage.setItem('users', JSON.stringify(users));

// 登录时
const users = JSON.parse(localStorage.getItem('users') || '[]');
const user = users.find(u => u.username === username.value && u.password === password.value);
if (user) {
  // 登录成功
}
```

#### 方案2：集成后端API（推荐）
```typescript
// 注册时
await axios.post('/api/register', {
  username: username.value,
  password: password.value
});

// 登录时
const response = await axios.post('/api/login', {
  username: username.value,
  password: password.value
});
localStorage.setItem('token', response.data.token);
```

---

## 六、常见问题解答

### Q1: 为什么刷新页面后还保持登录状态？
**A:** 因为登录状态存储在 `localStorage` 中，这是浏览器的持久化存储，除非手动清除或调用 `localStorage.clear()`，否则数据会一直保留。

### Q2: 如何退出登录？
**A:** 当前代码中没有实现退出功能，需要手动添加：
```typescript
const logout = () => {
  localStorage.removeItem('isLoggedIn');
  localStorage.removeItem('username');
  router.push('/login');
};
```

### Q3: 注册 lky/1234 后能登录吗？
**A:** **不能**。因为：
- 注册时数据没有被保存
- 登录时验证的是硬编码的 `lky/123456`
- 只有这个固定组合能通过验证

### Q4: 如果忘记密码怎么办？
**A:** 当前系统没有"忘记密码"功能，因为：
- 没有后端支持
- 没有用户数据库
- 密码是硬编码的

### Q5: 为什么 Profile.vue 能显示用户名？
**A:** 在 `Profile.vue` 第 73-78 行：
```typescript
onMounted(() => {
  const savedUsername = localStorage.getItem('username');
  if (savedUsername) {
    username.value = savedUsername;
  }
});
```
组件挂载时从 localStorage 读取登录时保存的用户名。

### Q6: 能在控制台手动设置登录状态吗？
**A:** **可以**（但这是安全漏洞）：
```javascript
// 在浏览器控制台执行
localStorage.setItem('isLoggedIn', 'true');
localStorage.setItem('username', 'hacker');
// 然后访问 /home，可以直接进入
```

---

## 七、代码文件索引

| 文件 | 路径 | 核心功能 |
|------|------|----------|
| 登录页 | `src/views/auth/Login.vue` | 硬编码验证、设置登录状态 |
| 注册页 | `src/views/auth/Register.vue` | 表单展示、无实际存储 |
| 路由配置 | `src/router/index.ts` | 路由定义、登录守卫 |
| 个人中心 | `src/views/user/Profile.vue` | 读取用户名显示 |
| 应用入口 | `src/main.ts` | 挂载路由和应用 |
| 根组件 | `src/App.vue` | 渲染路由视图 |

---

## 八、总结

### 当前系统的认证机制
1. **登录判断**：检查 `localStorage.isLoggedIn === 'true'`
2. **路由守卫**：未登录访问受保护页面 → 强制跳转登录页
3. **硬编码验证**：只有 `lky/123456` 能登录
4. **注册无效**：注册的数据不会被保存，无法使用

### 回答你的三个问题

**1. 如何判断登录状态？**
- 通过 `localStorage.isLoggedIn` 判断
- 路由守卫在每次跳转前检查
- 未登录访问受保护页面会重定向到 `/login`

**2. 注册 lky/1234 后能登录吗？**
- **不能**
- 注册的数据没有保存
- 登录验证只认硬编码的 `lky/123456`

**3. 登录和注册的逻辑？**
- **登录**：硬编码验证 → 成功则存储状态到 localStorage → 跳转首页
- **注册**：只显示提示 → 不保存数据 → 跳转登录页
- **守卫**：每次路由跳转前检查登录状态 → 决定放行或重定向
