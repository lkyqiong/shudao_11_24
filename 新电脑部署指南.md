# 云游蜀道项目 - 新电脑部署指南

## 📋 环境要求

在开始之前，请确保新电脑已安装以下软件：

| 软件 | 版本要求 | 下载地址 |
|------|---------|---------|
| **Node.js** | 16.0 或更高版本（推荐 18 或 20） | https://nodejs.org |
| **Python** | 3.8 或更高版本 | https://www.python.org |

**安装提示：**
- 安装 Node.js 时，保持默认选项即可
- 安装 Python 时，**务必勾选** "Add Python to PATH" 选项

---

## 📦 项目文件准备

### 打包项目（原电脑）

**需要压缩的文件和文件夹：**
```
✅ backend/              # 后端代码
✅ src/                  # 前端源代码
✅ public/               # 静态资源
✅ index.html            # 入口文件
✅ package.json          # 前端依赖配置
✅ package-lock.json     # 依赖锁定文件
✅ vite.config.ts        # Vite 配置
✅ tsconfig.json         # TypeScript 配置
✅ tsconfig.app.json
✅ tsconfig.node.json
✅ .gitignore
```

**不要压缩的文件夹：**
```
❌ node_modules/         # 体积太大，会重新安装
❌ dist/                 # 构建产物，可重新生成
❌ .vscode/              # 编辑器配置
```

**预期压缩包大小：** 10-50 MB

---

## 🚀 部署步骤

### Step 1: 解压项目文件

将压缩包解压到目标目录，例如：
```
D:\projects\shudao_11_24\
```

---

### Step 2: 打开命令行

**方法一（推荐）：**
1. 打开文件资源管理器
2. 进入项目文件夹 `D:\projects\shudao_11_24`
3. 在地址栏输入 `cmd` 然后按回车

**方法二：**
1. 按 `Win + R`，输入 `cmd`，按回车
2. 输入命令进入项目目录：
   ```bash
   cd /d D:\projects\shudao_11_24
   ```
   （将路径替换为你的实际路径）

---

### Step 3: 安装前端依赖

在命令行窗口输入以下命令：

```bash
npm install
```

**预期输出：**
```
added 200+ packages in 30-60s
```

**等待安装完成**，可能需要几分钟时间。

---

### Step 4: 安装后端依赖

继续在命令行输入：

```bash
cd backend
```

然后安装 Python 依赖：

```bash
pip install -r requirements.txt
```

**预期输出：**
```
Successfully installed fastapi-0.115.6 uvicorn-0.34.0 psycopg2-binary-2.9.10 ...
```

---

### Step 5: 启动后端服务

确保你在 `backend` 目录下，输入：

```bash
python main.py
```

**成功启动的标志：**
```
启动 FastAPI 服务器...
API 地址: http://localhost:8000
API 文档: http://localhost:8000/docs
INFO:     Uvicorn running on http://0.0.0.0:8000
```

**⚠️ 重要：不要关闭这个命令行窗口！让它保持运行。**

---

### Step 6: 启动前端服务

**打开第二个命令行窗口**（重复 Step 2 的方法），进入项目根目录，然后输入：

```bash
npm run dev
```

**成功启动的标志：**
```
VITE v7.2.4  ready in 500 ms

➜  Local:   http://localhost:5173/
➜  Network: use --host to expose
```

**⚠️ 不要关闭这个命令行窗口！**

---

### Step 7: 访问应用

1. 打开浏览器（推荐 Chrome 或 Edge）
2. 输入地址：`http://localhost:5173`
3. 使用以下账号登录：
   - **用户名：** `lky`
   - **密码：** `123456`

---

## ✅ 验证部署是否成功

按顺序测试以下功能：

1. ✅ **后端是否启动：** 浏览器访问 http://localhost:8000
   - 应显示：`{"message": "蜀道数据可视化 API 服务运行中"}`

2. ✅ **API 是否正常：** 访问 http://localhost:8000/api/poems
   - 应返回诗词数据的 JSON

3. ✅ **前端是否启动：** 访问 http://localhost:5173
   - 应显示登录页面

4. ✅ **能否登录：** 使用 `lky` / `123456` 登录

5. ✅ **地图是否显示标记点：**
   - 登录后进入"古迹篇"
   - 点击下拉菜单选择"诗词"
   - 地图上应显示标记点

---

## 📝 完整命令总结

```bash
# 第一个命令行窗口（后端）
cd /d D:\projects\shudao_11_24          # 进入项目目录
npm install                              # 安装前端依赖
cd backend                               # 进入后端目录
pip install -r requirements.txt          # 安装后端依赖
python main.py                           # 启动后端（保持运行）

# 第二个命令行窗口（前端）
cd /d D:\projects\shudao_11_24          # 进入项目目录
npm run dev                              # 启动前端（保持运行）
```

---

## ⚠️ 常见问题及解决方案

### 问题 1：`npm` 不是内部或外部命令

**原因：** 没有安装 Node.js 或未添加到环境变量

**解决方法：**
1. 下载安装 Node.js：https://nodejs.org
2. 安装完成后，**重启命令行窗口**
3. 输入 `node -v` 验证安装成功

---

### 问题 2：`pip` 不是内部或外部命令

**原因：** 没有安装 Python 或未添加到环境变量

**解决方法：**
1. 下载安装 Python：https://www.python.org
2. **重新安装时务必勾选 "Add Python to PATH"**
3. 安装完成后，**重启命令行窗口**
4. 输入 `python --version` 验证安装成功

---

### 问题 3：后端启动后立即报错或无法连接数据库

**原因：** 原电脑的 natapp 内网穿透未运行

**解决方法：**
1. 确保原电脑的 natapp 隧道正在运行
2. 确认隧道地址和端口没有变化
3. 如果隧道地址变化，需要修改 `backend/main.py` 中的配置：
   ```python
   DB_CONFIG = {
       "host": "新的natapp域名",
       "port": 新的端口号,
       "dbname": "shudao",
       "user": "postgres",
       "password": "123456"
   }
   ```

---

### 问题 4：端口被占用

**错误信息：**
```
Error: listen EADDRINUSE: address already in use :::8000
```

**解决方法：**
- **前端端口冲突：** Vite 会自动使用 5174、5175 等端口
- **后端端口冲突：** 修改 `backend/main.py` 最后一行：
  ```python
  uvicorn.run(app, host="0.0.0.0", port=8001)  # 改为 8001
  ```
  同时需要修改前端 API 地址 `src/services/api.ts`：
  ```typescript
  const API_BASE_URL = 'http://localhost:8001';
  ```

---

### 问题 5：psycopg2-binary 安装失败（Windows）

**错误信息：**
```
error: Microsoft Visual C++ 14.0 or greater is required
```

**解决方法：**
1. 下载安装 Visual C++ Build Tools
2. 或使用预编译版本：
   ```bash
   pip install psycopg2-binary --only-binary :all:
   ```

---

## 🔐 数据库连接说明

**重要提示：**
- 新电脑**不需要安装 PostgreSQL 数据库**
- 项目通过 natapp 内网穿透连接到原电脑的数据库
- **前提条件：原电脑必须保持开机，且 natapp 隧道正在运行**

**当前数据库配置：**
```python
DB_CONFIG = {
    "host": "0706193a7e944d72.natapp.cc",
    "port": 30543,
    "dbname": "shudao",
    "user": "postgres",
    "password": "123456"
}
```

---

## 📚 项目技术栈

### 前端
- Vue 3.5.24（Composition API）
- TypeScript 5.9.3
- Vite 7.2.4
- OpenLayers 10.7.0（地图框架）
- Mapbox Style 13.1.1（地图样式）
- AntV G6 5.0.50（知识图谱）

### 后端
- FastAPI 0.115.6
- Uvicorn 0.34.0
- PostgreSQL（通过 psycopg2-binary 2.9.10 连接）

---

## 📞 需要帮助？

如果遇到其他问题，请检查：
1. 两个命令行窗口是否都在运行
2. 浏览器控制台（F12）是否有错误信息
3. 后端命令行窗口是否有错误输出
4. natapp 隧道是否正常运行

---

**祝部署顺利！** 🚀
